name: Execute Java Migration

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository (org/repo-name)'
        required: true
        type: string
      target_branch:
        description: 'Branch to create for migration'
        required: false
        default: 'migration/java-25'
        type: string
      source_java_version:
        description: 'Current Java version'
        required: true
        type: choice
        options:
          - '8'
          - '11'
          - '17'
          - '21'
      dry_run:
        description: 'Dry run (no PR creation)'
        required: false
        default: false
        type: boolean

jobs:
  migrate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout migration-hub
        uses: actions/checkout@v4
        with:
          path: migration-hub

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          token: ${{ secrets.MIGRATION_PAT }}
          path: target-repo

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Load learned recipes
        run: |
          cd migration-hub
          python scripts/generate-recipes.py

      - name: Run OpenRewrite migration
        working-directory: target-repo
        run: |
          # Copy migration recipes to target repo
          mkdir -p .rewrite
          cp -r ../migration-hub/recipes/* .rewrite/

          # Detect build system and run appropriate migration
          if [ -f "pom.xml" ]; then
            echo "Detected Maven project"
            ../migration-hub/scripts/run-maven-migration.sh ${{ inputs.source_java_version }}
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "Detected Gradle project"
            ../migration-hub/scripts/run-gradle-migration.sh ${{ inputs.source_java_version }}
          else
            echo "Unknown build system"
            exit 1
          fi

      - name: Analyze migration results
        if: success()
        run: |
          cd migration-hub
          python scripts/analyze-migration.py \
            "${{ inputs.target_repo }}" \
            ../target-repo/build/rewrite/datatables

      - name: Create Pull Request
        if: ${{ !inputs.dry_run && success() }}
        uses: peter-evans/create-pull-request@v6
        with:
          path: target-repo
          token: ${{ secrets.MIGRATION_PAT }}
          branch: ${{ inputs.target_branch }}
          title: 'chore: Migrate to Java 25'
          body: |
            ## Java 25 Migration

            This PR migrates the application from Java ${{ inputs.source_java_version }} to Java 25.

            ### Changes Applied
            - OpenRewrite automated migrations
            - Learned patterns from previous migrations
            - Common fixes and best practices

            ### Next Steps
            - [ ] Review automated changes
            - [ ] Run tests locally
            - [ ] Update CI/CD configuration if needed
            - [ ] Check for any manual migration steps in comments

            ### Migration Report
            See workflow artifacts for detailed migration analysis.

            ---
            ðŸ¤– Generated by migration-hub workflow

      - name: Update learnings repository
        if: success()
        working-directory: migration-hub
        run: |
          git config user.name "Migration Bot"
          git config user.email "migration-bot@company.com"

          git add learnings/
          git add recipes/learned/

          if git diff --staged --quiet; then
            echo "No new learnings to commit"
          else
            git commit -m "learn: Add patterns from ${{ inputs.target_repo }} migration"
            git push
          fi

      - name: Upload migration report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-report-${{ inputs.target_repo }}
          path: |
            target-repo/build/rewrite/
            migration-hub/learnings/migrations.json
